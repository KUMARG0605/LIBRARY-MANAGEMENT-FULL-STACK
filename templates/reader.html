<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Book Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
        }

        .reader-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .toolbar {
            background-color: #2d2d2d;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .book-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .book-title {
            font-size: 18px;
            font-weight: 600;
            color: #4CAF50;
        }

        .book-author {
            font-size: 14px;
            color: #999;
        }

        .toolbar-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #555;
        }

        .btn-secondary:hover {
            background-color: #666;
        }

        .reader-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: #2d2d2d;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #444;
        }

        .sidebar h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .toc-item, .bookmark-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #3a3a3a;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toc-item:hover, .bookmark-item:hover {
            background-color: #4a4a4a;
            transform: translateX(5px);
        }

        .main-reader {
            flex: 1;
            background-color: #fafafa;
            overflow-y: auto;
            padding: 40px;
        }

        .pdf-viewer {
            width: 100%;
            min-height: 100%;
            background-color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .epub-viewer {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 60px;
            color: #333;
            line-height: 1.8;
            font-size: 18px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .controls-bar {
            background-color: #2d2d2d;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        .page-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .page-input {
            width: 80px;
            padding: 8px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: #e0e0e0;
            border-radius: 5px;
            text-align: center;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background-color: #3a3a3a;
            border-radius: 4px;
            margin: 0 20px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .icon-btn {
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background-color: #3a3a3a;
            color: #4CAF50;
        }

        .highlight-menu {
            position: absolute;
            background-color: #2d2d2d;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
        }

        .highlight-menu button {
            margin: 0 5px;
        }

        .note-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2d2d2d;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            z-index: 2000;
            display: none;
            min-width: 400px;
        }

        .note-popup textarea {
            width: 100%;
            min-height: 150px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: #e0e0e0;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
        }

        .settings-panel {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background-color: #2d2d2d;
            padding: 30px;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
            transition: right 0.3s;
            z-index: 1500;
            overflow-y: auto;
        }

        .settings-panel.active {
            right: 0;
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-group label {
            display: block;
            color: #4CAF50;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: #3a3a3a;
            outline: none;
            border-radius: 3px;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -300px;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s;
            }

            .sidebar.active {
                left: 0;
            }

            .epub-viewer {
                padding: 30px 20px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="reader-container">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="book-info">
                <button class="icon-btn" onclick="window.history.back()">
                    ‚Üê Back
                </button>
                <div>
                    <div class="book-title">{{ book.title }}</div>
                    <div class="book-author">by {{ book.author }}</div>
                </div>
            </div>
            <div class="toolbar-controls">
                <button class="btn btn-secondary" onclick="toggleSidebar()">üìë Contents</button>
                <button class="btn btn-secondary" onclick="addBookmark()">üîñ Bookmark</button>
                <button class="btn btn-secondary" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
                {% if digital_book.download_allowed %}
                <a href="{{ url_for('books.download_book', book_id=book.id) }}" class="btn">‚¨áÔ∏è Download</a>
                {% endif %}
            </div>
        </div>

        <!-- Main Content -->
        <div class="reader-content">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-section">
                    <h3>üìë Table of Contents</h3>
                    <div id="toc-list">
                        <div class="toc-item" onclick="goToPage(1)">Chapter 1</div>
                        <div class="toc-item" onclick="goToPage(25)">Chapter 2</div>
                        <div class="toc-item" onclick="goToPage(50)">Chapter 3</div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>üîñ Bookmarks</h3>
                    <div id="bookmarks-list">
                        <!-- Bookmarks will be added here -->
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>üñçÔ∏è Highlights</h3>
                    <div id="highlights-list">
                        <!-- Highlights will be added here -->
                    </div>
                </div>
            </div>

            <!-- Main Reader Area -->
            <div class="main-reader" id="mainReader">
                {% if digital_book.file_type == 'PDF' %}
                <iframe class="pdf-viewer" id="pdfViewer" 
                        src="/static/pdf-viewer.html?file={{ url_for('static', filename='uploads/' + digital_book.file_path) }}"></iframe>
                {% else %}
                <div class="epub-viewer" id="epubViewer">
                    <!-- EPUB content will be loaded here -->
                    <h1>{{ book.title }}</h1>
                    <h3>Chapter 1</h3>
                    <p>Book content will be loaded here...</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="controls-bar">
            <div class="page-controls">
                <button class="icon-btn" onclick="previousPage()">‚èÆÔ∏è</button>
                <button class="icon-btn" onclick="previousPage()">‚óÄÔ∏è</button>
                <input type="number" class="page-input" id="currentPage" value="{{ progress.current_page if progress else 1 }}" 
                       onchange="goToPage(this.value)">
                <span style="color: #999;">/ {{ digital_book.total_pages }}</span>
                <button class="icon-btn" onclick="nextPage()">‚ñ∂Ô∏è</button>
                <button class="icon-btn" onclick="nextPage()">‚è≠Ô∏è</button>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: {{ progress.percentage if progress else 0 }}%"></div>
            </div>

            <div class="zoom-controls">
                <button class="icon-btn" onclick="zoomOut()">üîç-</button>
                <span id="zoomLevel">100%</span>
                <button class="icon-btn" onclick="zoomIn()">üîç+</button>
                <button class="icon-btn" onclick="toggleFullscreen()">‚õ∂</button>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <h2 style="color: #4CAF50; margin-bottom: 30px;">‚öôÔ∏è Reader Settings</h2>
        
        <div class="setting-group">
            <label>Font Size</label>
            <input type="range" class="slider" min="12" max="24" value="18" 
                   onchange="changeFontSize(this.value)">
            <span id="fontSizeValue">18px</span>
        </div>

        <div class="setting-group">
            <label>Line Height</label>
            <input type="range" class="slider" min="1.2" max="2.5" step="0.1" value="1.8" 
                   onchange="changeLineHeight(this.value)">
            <span id="lineHeightValue">1.8</span>
        </div>

        <div class="setting-group">
            <label>Reading Mode</label>
            <select class="page-input" style="width: 100%;" onchange="changeTheme(this.value)">
                <option value="light">Light</option>
                <option value="sepia">Sepia</option>
                <option value="dark">Dark</option>
            </select>
        </div>

        <div class="setting-group">
            <label>Auto-save Progress</label>
            <input type="checkbox" checked onchange="toggleAutoSave(this.checked)"> Enabled
        </div>

        <button class="btn" style="width: 100%; margin-top: 20px;" onclick="toggleSettings()">Close</button>
    </div>

    <script>
        let currentPage = {{ progress.current_page if progress else 1 }};
        let totalPages = {{ digital_book.total_pages }};
        let zoom = 100;
        let autoSave = true;

        // Page Navigation
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                updatePage();
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updatePage();
            }
        }

        function goToPage(page) {
            page = parseInt(page);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                updatePage();
            }
        }

        function updatePage() {
            document.getElementById('currentPage').value = currentPage;
            let progress = (currentPage / totalPages) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            if (autoSave) {
                saveProgress();
            }
        }

        // Zoom Controls
        function zoomIn() {
            zoom += 10;
            applyZoom();
        }

        function zoomOut() {
            if (zoom > 50) {
                zoom -= 10;
                applyZoom();
            }
        }

        function applyZoom() {
            document.getElementById('zoomLevel').textContent = zoom + '%';
            document.getElementById('epubViewer').style.fontSize = (zoom / 100 * 18) + 'px';
        }

        // Sidebar Toggle
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // Settings Panel
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('active');
        }

        function changeFontSize(size) {
            document.getElementById('fontSizeValue').textContent = size + 'px';
            document.getElementById('epubViewer').style.fontSize = size + 'px';
        }

        function changeLineHeight(height) {
            document.getElementById('lineHeightValue').textContent = height;
            document.getElementById('epubViewer').style.lineHeight = height;
        }

        function changeTheme(theme) {
            const viewer = document.getElementById('mainReader');
            if (theme === 'sepia') {
                viewer.style.backgroundColor = '#f4ecd8';
                document.querySelector('.epub-viewer').style.backgroundColor = '#f4ecd8';
            } else if (theme === 'dark') {
                viewer.style.backgroundColor = '#2d2d2d';
                document.querySelector('.epub-viewer').style.backgroundColor = '#2d2d2d';
                document.querySelector('.epub-viewer').style.color = '#e0e0e0';
            } else {
                viewer.style.backgroundColor = '#fafafa';
                document.querySelector('.epub-viewer').style.backgroundColor = 'white';
                document.querySelector('.epub-viewer').style.color = '#333';
            }
        }

        function toggleAutoSave(enabled) {
            autoSave = enabled;
        }

        // Bookmarks
        function addBookmark() {
            const bookmark = {
                page: currentPage,
                date: new Date().toLocaleString()
            };
            
            const bookmarksList = document.getElementById('bookmarks-list');
            const bookmarkItem = document.createElement('div');
            bookmarkItem.className = 'bookmark-item';
            bookmarkItem.innerHTML = `Page ${currentPage}<br><small>${bookmark.date}</small>`;
            bookmarkItem.onclick = () => goToPage(currentPage);
            bookmarksList.appendChild(bookmarkItem);
            
            alert('Bookmark added at page ' + currentPage);
        }

        // Fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Save Progress
        function saveProgress() {
            fetch('/api/books/save-progress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    book_id: {{ book.id }},
                    page: currentPage,
                    percentage: (currentPage / totalPages) * 100
                })
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            switch(e.key) {
                case 'ArrowRight':
                    nextPage();
                    break;
                case 'ArrowLeft':
                    previousPage();
                    break;
                case 'f':
                    toggleFullscreen();
                    break;
            }
        });

        // Auto-save every 30 seconds
        setInterval(() => {
            if (autoSave) {
                saveProgress();
            }
        }, 30000);
    </script>
</body>
</html>
